<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>网络协议学习-传输层 | Coderhyp'Blog</title><meta name="description" content="传输层(Transport) 传输层有两个协议 TCP (Transmission Control Protocol)      传输控制协议 UDP(User Datagram Protocol)                 用户数据报协议      UDP一般用于实时场景  有些DNS可以用TCP 有的可以用UDP  UDP UDP是无连接的 减少了建立和释放连接的开销  UDP尽最大能力"><meta name="keywords" content="网络协议"><meta name="author" content="Hypeng"><meta name="copyright" content="Hypeng"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="http://yoursite.com/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="网络协议学习-传输层"><meta property="og:url" content="http://yoursite.com/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/"><meta property="og:site_name" content="Coderhyp'Blog"><meta property="og:description" content="传输层(Transport) 传输层有两个协议 TCP (Transmission Control Protocol)      传输控制协议 UDP(User Datagram Protocol)                 用户数据报协议      UDP一般用于实时场景  有些DNS可以用TCP 有的可以用UDP  UDP UDP是无连接的 减少了建立和释放连接的开销  UDP尽最大能力"><meta property="og:image" content="http://yoursite.com/-https:/i.loli.net/2020/08/06/3vZOJDP5ExM9bN8.png"><meta property="article:published_time" content="2021-03-13T06:06:45.000Z"><meta property="article:modified_time" content="2021-04-13T15:51:39.948Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2021-04-13 23:51:39'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 5.0.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">54</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">14</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">14</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%A0%E8%BE%93%E5%B1%82-Transport"><span class="toc-number">1.</span> <span class="toc-text">传输层(Transport)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#UDP"><span class="toc-number">1.1.</span> <span class="toc-text">UDP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E9%AA%8C%E5%92%8C"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">检验和</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%EF%BC%88Port%EF%BC%89"><span class="toc-number">1.1.0.2.</span> <span class="toc-text">端口（Port）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TCP"><span class="toc-number">1.2.</span> <span class="toc-text">TCP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP-%E7%9A%84%E9%A6%96%E9%83%A8"><span class="toc-number">1.2.1.</span> <span class="toc-text">TCP 的首部</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%81%8F%E7%A7%BB"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">数据偏移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E7%95%99"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">保留</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E9%AA%8C%E5%92%8C-1"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">检验和</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%87%E5%BF%97%E4%BD%8D%EF%BC%88Flags%EF%BC%89"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">标志位（Flags）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%8F%E5%8F%B7-%E7%A1%AE%E8%AE%A4%E5%8F%B7-%E7%AA%97%E5%8F%A3"><span class="toc-number">1.2.1.5.</span> <span class="toc-text">序号 确认号 窗口</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%8F%E5%8F%B7-Sequence-Number-seq"><span class="toc-number">1.2.1.5.1.</span> <span class="toc-text">序号(Sequence Number) seq</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4%E5%8F%B7-Acknowledgment-Number"><span class="toc-number">1.2.1.5.2.</span> <span class="toc-text">确认号(Acknowledgment Number)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3-Window"><span class="toc-number">1.2.1.5.3.</span> <span class="toc-text">窗口(Window)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TCP%E7%9A%84%E5%87%A0%E4%B8%AA%E8%A6%81%E7%82%B9"><span class="toc-number">1.2.2.</span> <span class="toc-text">TCP的几个要点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP%E5%8F%AF%E9%9D%A0%E4%BC%A0%E8%BE%93"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">TCP可靠传输</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2%E7%AD%89%E5%BE%85ARQ%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.2.2.1.1.</span> <span class="toc-text">停止等待ARQ协议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%9E%E7%BB%ADARQ%E5%8D%8F%E8%AE%AE-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.2.2.1.2.</span> <span class="toc-text">连续ARQ协议+滑动窗口协议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SACK%EF%BC%88%E9%80%89%E6%8B%A9%E6%80%A7%E7%A1%AE%E8%AE%A4%EF%BC%89"><span class="toc-number">1.2.2.1.3.</span> <span class="toc-text">SACK（选择性确认）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#question"><span class="toc-number">1.2.2.1.4.</span> <span class="toc-text">question</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">TCP流量控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">TCP拥塞控制</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.2.3.1.</span> <span class="toc-text">方法</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%85%A2%E5%BC%80%E5%A7%8B"><span class="toc-number">1.2.2.3.1.1.</span> <span class="toc-text">慢开始</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8B%A5%E5%A1%9E%E9%81%BF%E5%85%8D"><span class="toc-number">1.2.2.3.1.2.</span> <span class="toc-text">拥塞避免</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BF%AB%E9%87%8D%E4%BC%A0"><span class="toc-number">1.2.2.3.1.3.</span> <span class="toc-text">快重传</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BF%AB%E6%81%A2%E5%A4%8D"><span class="toc-number">1.2.2.3.1.4.</span> <span class="toc-text">快恢复</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%BF%AB%E9%87%8D%E4%BC%A0-%E5%BF%AB%E6%81%A2%E5%A4%8D"><span class="toc-number">1.2.2.3.1.5.</span> <span class="toc-text">快重传+快恢复</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">TCP连接管理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%8F%E5%8F%B7%E7%A1%AE%E8%AE%A4%E5%8F%B7%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3"><span class="toc-number">1.2.2.4.1.</span> <span class="toc-text">序号确认号深入理解</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%88%86%E6%9E%90"><span class="toc-number">1.2.2.4.1.1.</span> <span class="toc-text">具体分析</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5%E2%80%94%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B"><span class="toc-number">1.2.2.4.2.</span> <span class="toc-text">建立连接—三次握手</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%89%8D%E4%B8%A4%E6%AC%A1%E6%8F%A1%E6%89%8B%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">1.2.2.4.2.1.</span> <span class="toc-text">前两次握手的特点</span></a></li><li class="toc-item toc-level-6"><a class="toc-link"><span class="toc-number">1.2.2.4.2.2.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B-%E4%B8%A4%E6%AC%A1%E4%B8%8D%E8%A1%8C%E5%90%97"><span class="toc-number">1.2.2.4.2.3.</span> <span class="toc-text">为什么要三次握手 两次不行吗</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E7%AC%AC%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%A4%B1%E8%B4%A5%E4%BA%86-%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88"><span class="toc-number">1.2.2.4.2.4.</span> <span class="toc-text">如果第三次握手失败了 会发生什么</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%87%8A%E6%94%BE%E8%BF%9E%E6%8E%A5%E2%80%94%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B"><span class="toc-number">1.2.2.4.3.</span> <span class="toc-text">释放连接—四次挥手</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E8%A7%A3%E8%AF%BB"><span class="toc-number">1.2.2.4.3.1.</span> <span class="toc-text">状态解读</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%86%E8%8A%82"><span class="toc-number">1.2.2.4.3.2.</span> <span class="toc-text">细节</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%8A%93%E5%8C%85"><span class="toc-number">1.2.2.4.3.3.</span> <span class="toc-text">抓包</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E6%95%B4TCP%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.3.</span> <span class="toc-text">完整TCP流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Supplements"><span class="toc-number">1.2.4.</span> <span class="toc-text">Supplements</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%BA%E5%88%86%E9%95%BF%E8%BF%9E%E6%8E%A5%E7%9F%AD%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">区分长连接短连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%81%87%E8%AE%BE%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5%E6%B2%A1%E6%9C%89%E6%96%AD%E5%BC%80%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">假设建立连接没有断开连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Socket"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">Socket</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(/-https:/i.loli.net/2020/08/06/3vZOJDP5ExM9bN8.png)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Coderhyp'Blog</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">网络协议学习-传输层</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-03-13T06:06:45.000Z" title="Created 2021-03-13 14:06:45">2021-03-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-04-13T15:51:39.948Z" title="Updated 2021-04-13 23:51:39">2021-04-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">网络协议</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="传输层-Transport"><a href="#传输层-Transport" class="headerlink" title="传输层(Transport)"></a>传输层(Transport)</h1><ul>
<li>传输层有两个协议<ul>
<li><strong>TCP</strong> (Transmission Control Protocol)      传输控制协议</li>
<li><strong>UDP</strong>(User Datagram Protocol)                 用户数据报协议</li>
</ul>
</li>
</ul>
<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/csc.png" style="zoom:40%;">

<p>UDP一般用于实时场景 </p>
<p>有些DNS可以用TCP 有的可以用UDP </p>
<h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><ul>
<li><p>UDP是无连接的 减少了建立和释放连接的开销</p>
</li>
<li><p>UDP尽最大能力交付 不保证可靠交付</p>
<ul>
<li>因此UDP不需要维护一些复杂的参数 首部只有8个字节（TCP的首部至少有20个字节）</li>
</ul>
<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/UDP.png" style="zoom:50%;">
</li>
<li><p>UDP长度（Length）</p>
<ul>
<li>占16位 首部的长度+数据的长度 </li>
</ul>
</li>
</ul>
<h4 id="检验和"><a href="#检验和" class="headerlink" title="检验和"></a>检验和</h4><p>计算内容：伪首部+首部+数据</p>
<ul>
<li>伪首部只在计算检验和时起作用 不会传递给网络层</li>
</ul>
<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/jyh.png" style="zoom:50%;">

<h4 id="端口（Port）"><a href="#端口（Port）" class="headerlink" title="端口（Port）"></a>端口（Port）</h4><ul>
<li>UDP首部中端口是占用2字节<ul>
<li>可以推测出端口号的取值范围是 0 - 65535</li>
</ul>
</li>
<li>客户端的源端口是临时开启的随机端口</li>
<li>防火墙可以设置开启关闭某些端口提高安全性<ul>
<li>比如可以在数据库的端口设置防火墙 只有通过内部间接的形式可以访问</li>
</ul>
</li>
</ul>
<p>常用指令</p>
<ul>
<li>netstat-an:查看被占用的端口</li>
<li>netstat-anb:查看被占用的端口、占用端口的应用程序 </li>
<li>telnet主机端口:查看是否可以访问主机的某个端口</li>
</ul>
<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/port.png" style="zoom:50%;">



<h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/tcp.png" style="zoom:50%;">

<h3 id="TCP-的首部"><a href="#TCP-的首部" class="headerlink" title="TCP 的首部"></a>TCP 的首部</h3><h4 id="数据偏移"><a href="#数据偏移" class="headerlink" title="数据偏移"></a>数据偏移</h4><ul>
<li>取值范围是0x0101 ~ 0x1111</li>
<li>乘以4：首部长度 (Header Length )</li>
<li>数据偏移算首部长度 首部长度为多少数据就往右边偏移了多少<h4 id="保留"><a href="#保留" class="headerlink" title="保留"></a>保留</h4></li>
<li>占6位 目前全为0</li>
<li>有些资料保留位只有三位 标志字段占9位 </li>
</ul>
<p>TCP的一个细节</p>
<ul>
<li>UDP的首部中有个16位的字段记录了整个UDP报文段的长度(首部+数据)</li>
<li>但是,TCP的首部中仅仅有个4位的字段记录了TCP报文段的首部长度,并没有字段记录TCP报文段的数据长度</li>
<li>分析<ul>
<li>UDP首部中占16位的长度字段是<strong>冗余</strong>的,纯粹是为了保证首部是32bit对齐</li>
<li>TCP\UDP的数据长度,完全可以由IP数据包的首部推测出来</li>
<li>传输层的数据长度=网络层的总长度-网络层的首部长度-传输层的首部长度</li>
</ul>
</li>
</ul>
<h4 id="检验和-1"><a href="#检验和-1" class="headerlink" title="检验和"></a>检验和</h4><ul>
<li>检验和的计算内容： 伪首部+首部+数据</li>
<li>伪首部：占用12个字节 只在计算检验和时起作用 不会传递给网络层</li>
</ul>
<h4 id="标志位（Flags）"><a href="#标志位（Flags）" class="headerlink" title="标志位（Flags）"></a>标志位（Flags）</h4><ul>
<li>URG（Urgent）<ul>
<li>当URG为<strong>1</strong> 时，<strong>紧急指针</strong>字段才有效，表明当前报文段中有紧急数据 应优先尽快传送</li>
</ul>
</li>
<li>ACK (Acknowledgement )<ul>
<li>当ACK=1时，<strong>确认号</strong>字段才有效</li>
</ul>
</li>
<li>PSH(Push)</li>
<li>RST(Reset)<ul>
<li>当RST=1时，表明连接中出现严重差错 必须释放连接 然后重新建立连接</li>
</ul>
</li>
<li>SYN(Synchronization)<ul>
<li>当<strong>SYN = 1</strong> 时，<strong>ACK=0</strong>时，表明这是一个<strong>建立连接</strong>的请求</li>
<li>如果对方同意建立连接 回复SYN = 1 ，ACK = 1 </li>
</ul>
</li>
<li>Fin（Finish）<ul>
<li>当Fin 为1 表明数据发送完毕 要释放连接</li>
</ul>
</li>
</ul>
<h4 id="序号-确认号-窗口"><a href="#序号-确认号-窗口" class="headerlink" title="序号 确认号 窗口"></a>序号 确认号 窗口</h4><h5 id="序号-Sequence-Number-seq"><a href="#序号-Sequence-Number-seq" class="headerlink" title="序号(Sequence Number) seq"></a>序号(Sequence Number) seq</h5><ul>
<li>占4字节</li>
<li>首先 传输过程中的每一个字节都会有一个编号</li>
<li>在<strong>建立连接后</strong> 序号代表的是 这一次传给对方的TCP数据部分的第一个字节的编号</li>
<li>序号是告诉对方我现在发到哪里了</li>
</ul>
<h5 id="确认号-Acknowledgment-Number"><a href="#确认号-Acknowledgment-Number" class="headerlink" title="确认号(Acknowledgment Number)"></a>确认号(Acknowledgment Number)</h5><ul>
<li>占4个字节</li>
<li>在建立连接后 确认号代表期望对方下一次传过来的TCP数据部分的第一个字节的编号</li>
<li>确认号是告诉发送方我已经收到多少。请接下来发送多少的</li>
</ul>
<h5 id="窗口-Window"><a href="#窗口-Window" class="headerlink" title="窗口(Window)"></a>窗口(Window)</h5><ul>
<li>占2个字节</li>
<li>这个字段有流量控制功能 用于告知对方下一次允许发送的数据大小(字节为单位)</li>
</ul>
<h3 id="TCP的几个要点"><a href="#TCP的几个要点" class="headerlink" title="TCP的几个要点"></a>TCP的几个要点</h3><ul>
<li>可靠传输   保证服务器传输时丢包也能把丢的包传到客户端</li>
<li>流量控制</li>
<li>拥塞控制</li>
<li>连接管理<ul>
<li>建立连接</li>
<li>释放连接</li>
</ul>
</li>
</ul>
<h4 id="TCP可靠传输"><a href="#TCP可靠传输" class="headerlink" title="TCP可靠传输"></a>TCP可靠传输</h4><h5 id="停止等待ARQ协议"><a href="#停止等待ARQ协议" class="headerlink" title="停止等待ARQ协议"></a>停止等待ARQ协议</h5><ul>
<li>ARQ(Automatic Repeat-reQuest) 自动重传请求</li>
</ul>
<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/arq.png" style="zoom:50%;">

<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/qrds.png" style="zoom:50%;">

<h5 id="连续ARQ协议-滑动窗口协议"><a href="#连续ARQ协议-滑动窗口协议" class="headerlink" title="连续ARQ协议+滑动窗口协议"></a>连续ARQ协议+滑动窗口协议</h5><img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/lxarq.png" style="zoom:50%;">

<h5 id="SACK（选择性确认）"><a href="#SACK（选择性确认）" class="headerlink" title="SACK（选择性确认）"></a>SACK（选择性确认）</h5><ul>
<li>在TCP通信过程中，如果发送序列中间某个数据包丢失 （比如 1，2，3，4，5中的3丢失掉）</li>
<li>TCP会通过重传最后确认的分组后续的分组（最后确认的是2 会重传3，4，5）</li>
<li>这样原先已经正确传输的分组也可能重复发送（比如4，5） 降低了TCP性能</li>
</ul>
<p>为了改善这种情况 发展出了SACK（Selective Acknowledgment  选择性确认）技术</p>
<ul>
<li>告诉发送方哪些数据丢失 哪些数据已经提前收到</li>
<li>使TCP只重新发送丢失的包（比如3） 不用发送后续所有的分组（比如4，5）</li>
</ul>
<p>SACK信息会放在TCP首部的选项部分</p>
<ul>
<li>Kind:占1字节。值为5代表这是SACK选项</li>
<li>Length:占1字节。表明SACK选项一共占用多少字节 </li>
<li>left Edge:占4字节,左边界</li>
<li>Right Edge:占4字节,右边界</li>
</ul>
<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/sack.png" style="zoom:50%;">

<ul>
<li>一对边界信息需要占用8个字节 由于TCP首部的选项部分最多40个字节 所以<ul>
<li>SACK选项最多携带4组边界信息</li>
<li>SACK选项的最大占用字节数 = 4* 8 +2 = 34</li>
</ul>
</li>
</ul>
<h5 id="question"><a href="#question" class="headerlink" title="question"></a>question</h5><ul>
<li>如果有个包重传了N次还是失败 会一直持续重传到成功吗<ul>
<li>取决于系统的设置 比如有些系统 重传五次未成功就会发送reset报文（RST）断开</li>
</ul>
</li>
</ul>
<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/rst.png" style="zoom:50%;">

<ul>
<li>发送数据大小不足接收窗口的大小<ul>
<li>如果接收窗口最多能接收4个包<ul>
<li>但是发送方只发送了两个包</li>
</ul>
</li>
<li>接收方应该如何确定后面还有没有两个包<ul>
<li>等待一定时间后没有第三个包</li>
<li>就会返回确认收到两个包给发送方</li>
</ul>
</li>
</ul>
</li>
<li>为什么选择在传输层就将数据“大卸八块”分成多个段,而不是等到网络层再分片传递给数据链路层?<ul>
<li>因为可以提高重传的性能</li>
<li>如果在传输层分片 那对于传输层而言发了很多的包 对方的传输层也会接收到这些包 如果发生丢包 对方的传输层能告诉发送方的传输层丢的是哪个包</li>
<li>我们需要明确的是： 可靠传输是在传输层进行控制的<ul>
<li>如果在传输层不进行分段 那么一旦出现数据丢失  整个传输层的数据都需要进行重传</li>
<li>如果在传输层分了段,一旦出现数据丟失,只需要重传丟失的那些段即可</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="TCP流量控制"><a href="#TCP流量控制" class="headerlink" title="TCP流量控制"></a>TCP流量控制</h4><ul>
<li><p>如果接收方的缓存区满了 发送方还在疯狂发送数据</p>
<ul>
<li>接收方只能把收到的数据包丢掉 大量的丢包会极大的浪费网络资源</li>
<li>所以要进行流量控制</li>
</ul>
</li>
<li><p>什么是流量控制</p>
<ul>
<li>让发送方的发送速率不要太快 让接收方来得及接受处理 且为点对点</li>
</ul>
</li>
<li><p>原理</p>
<ul>
<li>通过确认报文中窗口字段来控制发送方的发送速率</li>
<li>发送方的<strong>发送窗口大小</strong>不能超过接收方给出窗口大小</li>
<li>当发送方收到接收窗口的大小为0时，发送方会停止发送数据</li>
</ul>
</li>
<li><p>有一种特殊情况</p>
<ul>
<li>一开始 接收方给发送方发送了0窗口的报文段</li>
<li>后面 接收方又有了一些存储空间 给发送方发送的非0 窗口的报文段丢失了</li>
<li>发送方的发送窗口一直为0 双方陷入僵局</li>
</ul>
</li>
<li><p>解决方案</p>
<ul>
<li>当发送方接收到0窗口通知，这时发送方停止发送报文</li>
<li>并且同时开启一个定时器 隔一段时间就发个测试报文去主动询问接收方最新的窗口大小</li>
<li>如果接受的窗口大小还是0 发送方就会停止发送数据</li>
</ul>
</li>
</ul>
<h4 id="TCP拥塞控制"><a href="#TCP拥塞控制" class="headerlink" title="TCP拥塞控制"></a>TCP拥塞控制</h4> <img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/拥塞控制.png" style="zoom:50%;">

<ul>
<li>拥塞控制<ul>
<li>防止过多的数据注入到网络中</li>
<li>避免网络中的路由器或链路过载</li>
</ul>
</li>
<li>拥塞控制是一个<strong>全局性</strong>的过程<ul>
<li>涉及到所有的主机 路由器</li>
<li>以及与降低网络传输性能有关的所有因素</li>
<li>是大家一起努力的结果</li>
</ul>
</li>
<li>相比而言 流量控制是点对点通信的控制</li>
</ul>
<h5 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h5><p>几个缩写</p>
<ul>
<li>MSS(Maxinum Segment Size) ： 每个段最大的数据部分大小<ul>
<li>在<strong>建立连接时</strong>确定</li>
</ul>
</li>
<li>rwnd(receive window)：        接收窗口大小</li>
<li>cwnd(congestion window):   拥塞窗口大小  根据网络状况调整</li>
<li>swnd(send window):             发送窗口<ul>
<li>swnd = <strong>min</strong>(cwnd,rwnd)</li>
</ul>
</li>
</ul>
<p>方法：</p>
<ul>
<li>慢开始 (slow start 慢启动)</li>
<li>拥塞避免 (congestion avoidance)</li>
<li>快速重传 (fast retransmit)</li>
<li>快速恢复 (fast recovery)</li>
</ul>
<h6 id="慢开始"><a href="#慢开始" class="headerlink" title="慢开始"></a>慢开始</h6><img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/慢开始.png" style="zoom:40%;">

<ul>
<li>cwnd 的初始值比较小 然后随着数据包被确认方确认(收到一个ACK)<ul>
<li>cwnd 就会成倍增长</li>
</ul>
</li>
</ul>
<h6 id="拥塞避免"><a href="#拥塞避免" class="headerlink" title="拥塞避免"></a>拥塞避免</h6><img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/拥塞避免.png" style="zoom:40%;">

<ul>
<li>ssthresh(slow start threshold)：慢开始阈值 cwnd打到阈值后 以线性方式增加</li>
<li>拥塞避免(加法增大) ：拥塞窗口缓慢增大 以防止网络过早出现拥塞</li>
<li>乘法减小：只要网络出现拥塞 减半sshresh 与此同时 执行慢开始算法 （cwnd又恢复到初始值）</li>
<li>当网络频繁拥塞 sshresh 值就下降很快</li>
</ul>
<h6 id="快重传"><a href="#快重传" class="headerlink" title="快重传"></a>快重传</h6><ul>
<li>接收方<ul>
<li>每收到一个<strong>失序</strong>的分组后就立即发送一个重复确认</li>
<li>这样发送方能够及时知道有分组没到到达</li>
<li>而不需要等待自己发送数据时候才进行确认</li>
</ul>
</li>
<li>发送方<ul>
<li>只要连续收到三个重复确认(总共四个相同的确认) 就应当立即重传对方尚未收到的报文段</li>
<li>而不必继续等待重传计时器到期后再重传</li>
</ul>
</li>
</ul>
<h6 id="快恢复"><a href="#快恢复" class="headerlink" title="快恢复"></a>快恢复</h6><ul>
<li>当发送方连续收到三个重复确认， 就执行乘法减小算法 把ssthresh减半<ul>
<li>这是为了预防网络发生拥塞</li>
</ul>
</li>
<li>由于发送方现在认为网络很可能没有发生拥塞<ul>
<li>因此 与慢开始不同之处是现在不执行慢开始算法，即cwnd现在不恢复到初始值</li>
<li>而是把cwnd值设置为ssthresh 减半后的数值</li>
<li>然后开始执行拥塞避免算法(“加法增大” ) 使拥塞窗口缓慢的线性增大</li>
</ul>
</li>
</ul>
<h6 id="快重传-快恢复"><a href="#快重传-快恢复" class="headerlink" title="快重传+快恢复"></a>快重传+快恢复</h6><img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/kcckhf.png" style="zoom:40%;">



<p>发送窗口的最大值 ： swnd = min(cwnd，rwnd)</p>
<ul>
<li>当rwnd&lt;cwnd时,是接收方的接收能力限制发送窗口的最大值</li>
<li>当cwnd&lt;rwnd时,则是网络的拥塞限制发送窗口的最大值</li>
</ul>
<h4 id="TCP连接管理"><a href="#TCP连接管理" class="headerlink" title="TCP连接管理"></a>TCP连接管理</h4><h5 id="序号确认号深入理解"><a href="#序号确认号深入理解" class="headerlink" title="序号确认号深入理解"></a>序号确认号深入理解</h5><blockquote>
<p>注意 ACK 代表的是标志位中的确认号字段有效   而ack是代表确认号</p>
</blockquote>
 <img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/连接.png" style="zoom:40%;">

<p>真正的序号是一个很大的值 这个值在建立连接时确定</p>
<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/真实数据.png" style="zoom:50%;">

<p>连接过程：</p>
<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/连接过程.png" style="zoom:40%;">

<h6 id="具体分析"><a href="#具体分析" class="headerlink" title="具体分析"></a>具体分析</h6><img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/synack.png" style="zoom:40%;">

<ul>
<li>基于相对值分析<ul>
<li>第一步的时候是客户端想要和服务器建立连接  SYN 为1 且ack seq为0  </li>
<li>第二步是服务端做出响应 这时ACK为1(0+1) 这时服务端第一次发送 seq也为0</li>
<li>第三步ack为1(0+1) 第二步ack期望从1开始的数据 第三步要对这个期望做出响应 所以seq 为1 但是这时数据依然是0个字节</li>
<li>第四步发送HTTP请求给服务器  这时TCP数据部分假设有k个字节的数据 ack这时是期望服务器发送的数据从1开始(因为上一次服务器发送的数据还是0)  seq是因为上一次服务器期望的也是从1开始 所以seq的值也是1</li>
<li>只有前两次SYN标志位为1</li>
</ul>
</li>
</ul>
<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/fwq传.png" style="zoom:40%;">

<ul>
<li>服务端返回的5~8步<ul>
<li>第N个包的序号 是前面第N-1<strong>个</strong>包数据的总长度+1 </li>
<li>他们的ack是k+1 因为是相对于客户端而客户端发送的字节为k </li>
</ul>
</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/%E7%A1%AE%E8%AE%A4.png"></p>
<ul>
<li>最后一步 确认<ul>
<li>客户端按照服务器端ack 所以seq为k+1</li>
<li>ack 是期望服务器发b1+b2+b3+b4+1编号开始的字节 (注意seq的意思是序号啊！所以是最后一个包的序号加上最后一个包的长度)</li>
</ul>
</li>
</ul>
<p>如果是原生的：</p>
<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/原生.png" style="zoom:40%;">

<p>实际上 在上面的表格中 原生值减初始值就是相对值</p>
<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/图解.png" style="zoom:50%;">

<h5 id="建立连接—三次握手"><a href="#建立连接—三次握手" class="headerlink" title="建立连接—三次握手"></a><strong>建立连接—三次握手</strong></h5><p><img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png"></p>
<ul>
<li><strong>CLOSED</strong> ： client 处于关闭状态</li>
<li><strong>LISTEN</strong> ：server处于监听状态 等待client 连接</li>
<li><strong>SYN-RCVD</strong>： 表示server 接收到了SYN报文， 当收到client的ACK报文时候 server进入到ESTABLISHED状态 表明收到了第一次握手</li>
<li><strong>SYN-SENT</strong>：表示client 已经发送了SYN报文等待server进行第2次握手</li>
<li><strong>ESTABLISHED</strong>：表示连接已经建立</li>
</ul>
<h6 id="前两次握手的特点"><a href="#前两次握手的特点" class="headerlink" title="前两次握手的特点"></a>前两次握手的特点</h6><ul>
<li>SYN都为1 </li>
<li>数据部分长度都为0 </li>
<li>TCP头部的长度一般是32个字节<ul>
<li>固定头部 ： 20字节</li>
<li>选项部分： 12字节</li>
</ul>
</li>
<li>双方会交换一些信息<ul>
<li>比如MSS ，是否支持SACK ，Window scale(窗口缩放系数  就是窗口的值✖️这个值 为窗口真正容纳大小)等</li>
<li>这些数据都放在了TCP头部的选项部分</li>
</ul>
</li>
</ul>
<h6 id><a href="#" class="headerlink" title></a></h6><h6 id="为什么要三次握手-两次不行吗"><a href="#为什么要三次握手-两次不行吗" class="headerlink" title="为什么要三次握手 两次不行吗"></a>为什么要三次握手 两次不行吗</h6><ul>
<li>主要目的：防止server端一直等待 造成资源浪费 </li>
<li>如果建立连接只需要两次握手 可能出现的情况<ul>
<li>假设 client 发送的第一个连接请求报文段 因为网络延迟的原因 在连接释放以后的某个时间才能到达server</li>
<li>本来这个连接时早已失效的 但是server收到这个失效的请求后，会误认为是client 再次发送的一个新的连接请求</li>
<li>这个时候server就会向client发出确认报文段 同意建立连接</li>
<li>如果采用的不是三次握手 那么只要server发出确认 那么新的连接就建立了</li>
<li>由于现在client并没有真正想连接服务器的意愿，因此不会理睬server的确认  也不会向server发送数据</li>
<li>但是server却以为新的连接已经建立， 并且一直等待client发来数据  这样server的很多资源就白白浪费掉了</li>
</ul>
</li>
<li>如果采用三次握手的办法可以防止上述现象发生<ul>
<li>例如上述的情况 client 没有向server 的确认发出确认 server 由于收不到确认 server 就知道client 并没有要求建立连接</li>
</ul>
</li>
</ul>
<h6 id="如果第三次握手失败了-会发生什么"><a href="#如果第三次握手失败了-会发生什么" class="headerlink" title="如果第三次握手失败了 会发生什么"></a>如果第三次握手失败了 会发生什么</h6><ul>
<li>此时server的状态为SYN-RECV 若等不到client的ACK server会重新发送SYN+ACK 包</li>
<li>如果server <strong>多次重发</strong>SYN+ACK都等不到client 的ACK 就会发送RST包 强制关闭连接</li>
</ul>
<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/RCVD.png" style="zoom:50%;">

<h5 id="释放连接—四次挥手"><a href="#释放连接—四次挥手" class="headerlink" title="释放连接—四次挥手"></a>释放连接—四次挥手</h5><img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/四次挥手.png" style="zoom:50%;">

<h6 id="状态解读"><a href="#状态解读" class="headerlink" title="状态解读"></a>状态解读</h6><ul>
<li><p><strong>FIN-WAIT-1</strong>：表示想主动关闭连接</p>
<ul>
<li>向对方发送了FIN报文 此时进入到FIN-WAIT-1 状态</li>
</ul>
</li>
<li><p><strong>CLOSE-WAIT</strong>：表示在等待关闭</p>
<ul>
<li>当对方发送FIN给自己， 自己会回应一个ACK报文给对方 此时则进入到CLOSE-WAIT状态</li>
<li>在这个状态下 <strong>需要考虑</strong>自己<strong>是否还有数据</strong>要发送给对方 如果没有 发送FIN报文给对方</li>
</ul>
</li>
<li><p><strong>FIN-WAIT-2</strong> :只要对方发送ACK确认后 主动方就会处于FIN-WAIT-2状态 然后<strong>等待对方发送FIN报文</strong></p>
</li>
<li><p><strong>CLOSING</strong>:一种比较罕见的例外状态</p>
<ul>
<li>表示你发送FIN报文后,并没有收到对方的ACK报文,反而却也收到了对方的FIN报文</li>
<li>如果双方几乎在同时准备关闭连接的话,那么就出现了双方同时发送IN报文的情況,也即会出现 CLOSING状态</li>
<li>表示双方都正在关闭连接</li>
</ul>
</li>
<li><p><strong>LAST-ACK</strong>：被动关闭的一方在发送FIN报文后 最后等待对方的ACK报文</p>
<ul>
<li>当收到了ACK报文后 就可以进入CLOSED 状态了</li>
</ul>
</li>
<li><p><strong>TIME-WAIT</strong></p>
<ul>
<li>表示收到了对方的FIN报文了  并且发出了ACK报文 就等2MSL后即可进入CLOSED状态了<ul>
<li>如果FIN-WAIT-1状态下 收到了对方同时带FIN 标志和ACK标志的报文时<ul>
<li>可以直接进入到TIME-WAIT 状态 而无须经过FIN-WAIT-2状态</li>
<li>(如果同时受到了二次三次挥手合并 那么可以没有FIN-WAIT-2状态)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>CLOSED</strong> ：关闭状态</p>
</li>
</ul>
<p>由于有些状态的时间比较短暂  所以很难用netstat 的命令看到 比如SYN-RCVD，FIN-WAIT-1等</p>
<h6 id="细节"><a href="#细节" class="headerlink" title="细节"></a><strong>细节</strong></h6><ul>
<li><p>TCP/IP 协议栈在设计上， <strong>允许任何一方先发起断开请求</strong>， 上文演示的是client主动要求断开</p>
</li>
<li><p>client 发送ACK后 需要有个<strong>TIME-WAIT</strong>阶段来等待一段时间后 再真正关闭连接</p>
<ul>
<li>一般是等待两倍的MSL（Maximum Segment LifeTime，最大分段生存期）</li>
<li><strong>MSL</strong>是TCP报文在Internet上的最长生存时间</li>
<li>每个具体的TCP实现都必须选择一个确定的MSL值,<a target="_blank" rel="noopener" href="https://www.rfc-editor.org/rfc/rfc1122.html">RFC 1122</a>建议是2分钟</li>
<li><u>可以防止本次连接中产生的数据包误传到下一次的连接中(因为本次连接中的数据包都会在2MSL时间内消失了 这样就可以保证不会误传)</u> </li>
</ul>
</li>
<li><p>如果client 发送ack之后马上释放了 然后又因为网络的原因 server没有收到client的ACK  server就会重新发送FIN</p>
<ul>
<li>这个时候的情况是<ul>
<li>client 没有任何响应 服务器在干等着 甚至多次重发FIN  会浪费资源</li>
<li>client 有个新的应用程序刚好分配了<strong>同一个端口号</strong> 新的应用程序收到server再次发送FIN后马上开始执行断开连接的操作（Server发送FIN是通过端口号）  然后这个新的应用程序可能是想和server建立连接</li>
</ul>
</li>
</ul>
</li>
</ul>
<img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/四次图解.png" style="zoom:40%;">

<h6 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h6><ul>
<li>有时候在使用抓包工具的时候 可能只会看到3次挥手<ul>
<li>这时其实是第2，3次挥手合并了</li>
</ul>
</li>
</ul>
<p><img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/%E5%90%88%E5%B9%B6.png"></p>
<ul>
<li>当 server接收到 clientl的FIN时,如果 server后面也没有数据要发送给 client了</li>
<li>这时,serveri就可以将第2、3次挥手合并,同时告诉 client两件事<ul>
<li>已经知道 client没有数据要发 </li>
<li>server已经没有数据要发了</li>
</ul>
</li>
</ul>
<h3 id="完整TCP流程"><a href="#完整TCP流程" class="headerlink" title="完整TCP流程"></a>完整TCP流程</h3><p><img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/完整流程.png" style="zoom:50%;">c</p>
<h3 id="Supplements"><a href="#Supplements" class="headerlink" title="Supplements"></a>Supplements</h3><h4 id="区分长连接短连接"><a href="#区分长连接短连接" class="headerlink" title="区分长连接短连接"></a>区分长连接短连接</h4><p>首先要判断是长连接还是短连接要知道为什么建立连接 </p>
<ul>
<li>如果是客户端发完请求拿到数据后马上断开连接 那么就是<strong>短连接</strong></li>
<li>如果建立连接以后有很多次数据交互 那么就是<strong>长连接</strong><ul>
<li>长连接释放时间根据需求</li>
</ul>
</li>
</ul>
<h4 id="假设建立连接没有断开连接"><a href="#假设建立连接没有断开连接" class="headerlink" title="假设建立连接没有断开连接"></a>假设建立连接没有断开连接</h4><p>并不是对网卡造成影响 而是在内存中的有socket对象  会对内存有影响</p>
<h4 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h4><img src= "/img/loading.gif" data-lazy-src="/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/socket.png" style="zoom:40%;">

<p>客户端的socket和服务器端的socket的连接是独立的  关闭等操作不会对其他造成影响</p>
<p>socket是一对一释放连接</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Hypeng</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/">http://yoursite.com/2021/03/13/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0-%E4%BC%A0%E8%BE%93%E5%B1%82/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/">网络协议</a></div><div class="post_share"><div class="social-share" data-image="/-https:/i.loli.net/2020/08/06/3vZOJDP5ExM9bN8.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/03/13/%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95%E9%A2%98/"><img class="prev-cover" data-lazy-src="/-https:/i.loli.net/2020/08/06/3vZOJDP5ExM9bN8.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">前端面试题(一)</div></div></a></div><div class="next-post pull-right"><a href="/2021/03/12/%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95%E4%B9%8BWeb%E5%AE%89%E5%85%A8/"><img class="next-cover" data-lazy-src="/-https:/i.loli.net/2020/08/06/3vZOJDP5ExM9bN8.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">前端面试之Web安全</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2021/03/09/网络协议学习-MAC地址与IP地址/" title="网络协议学习-MAC地址与IP地址"><img class="relatedPosts_cover" data-lazy-src="-https://i.loli.net/2020/08/06/3vZOJDP5ExM9bN8.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-09</div><div class="relatedPosts_title">网络协议学习-MAC地址与IP地址</div></div></a></div><div class="relatedPosts_item"><a href="/2021/03/10/网络协议学习-物理层_数据链路层/" title="物理层_数据链路层"><img class="relatedPosts_cover" data-lazy-src="-https://i.loli.net/2020/08/06/3vZOJDP5ExM9bN8.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="relatedPosts_title">物理层_数据链路层</div></div></a></div><div class="relatedPosts_item"><a href="/2021/03/12/网络协议学习-网络层/" title="网络协议学习-网络层"><img class="relatedPosts_cover" data-lazy-src="-https://i.loli.net/2020/08/06/3vZOJDP5ExM9bN8.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-12</div><div class="relatedPosts_title">网络协议学习-网络层</div></div></a></div><div class="relatedPosts_item"><a href="/2021/03/10/网络协议学习-路由-局域网/" title="网络协议学习-路由_局域网"><img class="relatedPosts_cover" data-lazy-src="-https://i.loli.net/2020/08/06/3vZOJDP5ExM9bN8.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-10</div><div class="relatedPosts_title">网络协议学习-路由_局域网</div></div></a></div><div class="relatedPosts_item"><a href="/2021/02/18/网络协议学习-邂逅/" title="网络协议学习-邂逅"><img class="relatedPosts_cover" data-lazy-src="-https://i.loli.net/2020/08/06/3vZOJDP5ExM9bN8.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-18</div><div class="relatedPosts_title">网络协议学习-邂逅</div></div></a></div></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By Hypeng</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span></div><div class="icp"><a><img class="icp-icon" src="/img/icp.png"/><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">辽ICP备20010781号</a></a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="Increase Font Size"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="Decrease Font Size"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>